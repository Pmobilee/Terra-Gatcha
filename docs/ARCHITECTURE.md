# Architecture — Terra Miner

System architecture overview covering frontend game, UI layer, sprite pipeline, and planned backend.

## High-Level Architecture
```
[Mobile Device / Browser]
    |
    ├── Svelte UI Layer (menus, HUD, quiz overlay)
    │     ↕ events
    ├── Phaser 3 Game Engine (canvas rendering, physics, input)
    │     ↕ asset loading
    ├── Service Layer (API client, cache, state persistence)
    │     ↕ HTTPS
    └── Backend API (Fastify + TypeScript) [planned]
          ↕
        Database (PostgreSQL) [planned]

[Development Machine]
    |
    └── ComfyUI Sprite Pipeline (local GPU, RTX 3060)
          → processed PNGs → committed to src/assets/
```

## Frontend Architecture

### Rendering Stack
- **Phaser 3**: Handles all game rendering on a single `<canvas>` element
- **Svelte 5**: Renders DOM-based UI overlays (menus, quiz, HUD) on top of the canvas
- **Communication**: Svelte dispatches events to Phaser scenes; Phaser emits events back

### State Management
- **Game State**: Managed within Phaser scene data and a central GameState class
- **UI State**: Svelte stores (writable/derived) for reactive UI updates
- **Persistence**: LocalStorage for save data, with migration versioning
- **Sync**: Game state syncs to backend API when online, falls back to local

### Asset Pipeline
1. Sprites generated by ComfyUI (developer machine)
2. Post-processed (background removal, palette normalization, spritesheet packing)
3. Committed to `src/assets/` as optimized PNGs
4. Loaded by Phaser's asset loader at runtime

## Data Flow

### Quiz Flow
```
Player mines block → Discovery event → Phaser pauses
  → Svelte quiz overlay appears → Fetch question from cache/API
  → Player answers → SM-2 algorithm updates card → Result to Phaser
  → Phaser resumes with reward/penalty
```

### Caching Strategy
- Service Worker caches all static assets (sprites, audio, fonts)
- Quiz questions pre-fetched in batches (50 at a time)
- Stale-while-revalidate for quiz data
- Player progress synced on connectivity change

## Backend Architecture (Planned)
- **Framework**: Fastify + TypeScript
- **Database**: PostgreSQL with Drizzle ORM
- **Auth**: JWT tokens with refresh rotation
- **API**: RESTful with OpenAPI schema validation
- **Deployment**: Docker container, deployable to Railway/Fly.io/Render

## Security Architecture
See `docs/SECURITY.md` for full details.
- CSP headers restrict script and resource origins
- All API communication over HTTPS
- Input validation on both client and server
- No dynamic code execution (eval, Function, innerHTML)
